unit Demo01_MainForm;


interface



uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, ExtCtrls,
  VFrames, Vcl.StdCtrls,JPEG;

type
  TForm1 = class(TForm)
    PaintBox1: TPaintBox;
    Image1: TImage;
    Button1: TButton;
    Image2: TImage;
    Label1: TLabel;
    Edit1: TEdit;
    procedure FormActivate(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure Button1Click(Sender: TObject);
    procedure Edit1Change(Sender: TObject);
  private
    { Private declarations }
    fActivated : boolean;
    fVideoImage: TVideoImage;
  public
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}


procedure TForm1.FormCreate(Sender: TObject);
begin
  //PaintBox1.Align := alClient;
  fActivated      := false;

  // Create instance of our video image class.
  fVideoImage     := TVideoImage.Create;
  // Tell fVideoImage where to paint the images it receives from the camera
  // (Only in case we do not want to modify the images by ourselves)
  //fVideoImage.SetDisplayCanvas(PaintBox1.Canvas);
  fVideoImage.SetDisplayCanvas(Image1.Canvas);

  Caption := 'Demo01  [Initializing video...]';
end;




procedure TForm1.Button1Click(Sender: TObject);
var
  MyJPEG: TJPEGImage;
  MyBitmap: TBitmap;
begin
  MyJPEG := TJPEGImage.Create;
  MyBitmap := TBitmap.Create;
  try
    fVideoImage.GetBitmap(MyBitmap);

    MyJPEG.Assign(MyBitmap);

    MyJPEG.CompressionQuality := 90;

    MyJPEG.SaveToFile('D:\abc.jpg');

    Image2.Picture.Assign(MyJPEG);

    ShowMessage('JPG Success');
  finally
    MyBitmap.Free;
    MyJPEG.Free;
  end;
end;

procedure TForm1.Edit1Change(Sender: TObject);
var
  MyJPEG: TJPEGImage;
  MyBitmap: TBitmap;
begin
  // เช็คความยาวของบาร์โค้ด (เช่น 13 หลัก ตามตัวอย่าง 8850999002668)
  if Length(Edit1.Text) = 13 then
  begin
    MyJPEG := TJPEGImage.Create;
    MyBitmap := TBitmap.Create;
    try
      // 1. ดึงภาพจากกล้อง
      fVideoImage.GetBitmap(MyBitmap);

      // 2. แปลงเป็น JPEG โดยใช้ Unit JPEG (ตามที่คุณต้องการ)
      MyJPEG.Assign(MyBitmap);
      MyJPEG.CompressionQuality := 90;

      // 3. บันทึกไฟล์โดยใช้หมายเลขบาร์โค้ดเป็นชื่อไฟล์
      MyJPEG.SaveToFile('D:\' + Edit1.Text + '.jpg');

      // 4. แสดงภาพใน Image2 เพื่อยืนยันผล
      Image2.Picture.Assign(MyJPEG);

      // เลือกข้อความใน Edit1 ทั้งหมด เพื่อให้การแสกนครั้งต่อไปทับค่าเก่าได้ทันที
      Edit1.SelectAll;

    finally
      MyBitmap.Free;
      MyJPEG.Free;
    end;
  end;
end;

procedure TForm1.FormActivate(Sender: TObject);
var
  DeviceList: TStringList;
begin
  IF fActivated then
    exit;
  fActivated := true;


  // Get list of available cameras
  DeviceList := TStringList.Create;
  fVideoImage.GetListOfDevices(DeviceList);


  IF DeviceList.Count < 1 then
    begin
      // If no camera has been found, terminate program
      Caption := 'Demo01  [No video device found]';
      MessageDlg('No video device found.'#10'Application will terminate.', mtError, [mbOK], 0);
      Application.Terminate;
      exit;
    end
    else begin
      // If at least one camera has been found, initialize first camera within the list
      fVideoImage.VideoStart(DeviceList[0]);
      Caption := '01  ['+DeviceList[0]+']';
    end;
end;



procedure TForm1.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  fVideoImage.VideoStop;
end;

end.
