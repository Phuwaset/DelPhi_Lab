unit barCode;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, ExtCtrls, VFrames, Vcl.StdCtrls, JPEG;

type
  TFrMain = class(TForm)
    Edit1: TEdit;
    Label1: TLabel;
    Image1: TImage;
    Image2: TImage;
    Button1: TButton;
    procedure Edit1Change(Sender: TObject);
    // เพิ่ม Event เหล่านี้ (ต้องไปดับเบิลคลิกที่หน้า Events ของ Form ด้วยนะครับ)
    procedure FormCreate(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
  private
    { Private declarations }
    fVideoImage: TVideoImage;
    fActivated : boolean;
  public
    { Public declarations }
  end;

var
  FrMain: TFrMain;

implementation

{$R *.dfm}

{ --- 1. เตรียมตัวแปรกล้องเมื่อเปิดโปรแกรม --- }
procedure TFrMain.FormCreate(Sender: TObject);
begin
  fActivated := false;
  fVideoImage := TVideoImage.Create;
  // ตั้งค่าให้แสดงภาพสดที่ Image1
  fVideoImage.SetDisplayCanvas(Image1.Canvas);
end;

{ --- 2. สั่งเปิดกล้องเมื่อหน้าจอพร้อม --- }
procedure TFrMain.FormActivate(Sender: TObject);
var
  DeviceList: TStringList;
begin
  if fActivated then exit;
  fActivated := true;

  DeviceList := TStringList.Create;
  try
    fVideoImage.GetListOfDevices(DeviceList);
    if DeviceList.Count > 0 then
      fVideoImage.VideoStart(DeviceList[0]) // เลือกกล้องตัวแรก
    else
      ShowMessage('ไม่พบกล้องเชื่อมต่ออยู่');
  finally
    DeviceList.Free;
  end;
end;

{ --- 3. บันทึกภาพเมื่อแสกนบาร์โค้ด --- }
procedure TFrMain.Edit1Change(Sender: TObject);
var
  JPG: TJPEGImage;
  FileName: string;
begin
  // ตรวจสอบว่ามีข้อมูลและกล้องทำงานอยู่
  if (Edit1.Text = '8850999002668') and (fVideoImage.IsPaused = false) then
  begin
    JPG := TJPEGImage.Create;
    try
      // ดึงภาพจากกล้อง
      JPG.Assign(fVideoImage.Bitmap);
      JPG.CompressionQuality := 80;

      FileName := 'D:\' + Edit1.Text + '.jpg';
      JPG.SaveToFile(FileName);

      // แสดงภาพที่บันทึกได้ใน Image2 เพื่อให้ดูผลงาน
      Image2.Picture.LoadFromFile(FileName);

      ShowMessage('บันทึกภาพรหัส ' + Edit1.Text + ' สำเร็จ');
    finally
      JPG.Free;
    end;

    Edit1.Text := ''; // ล้างค่าเตรียมรับบาร์โค้ดถัดไป
    Edit1.SetFocus;
  end;
end;

{ --- 4. ปิดกล้องเมื่อปิดโปรแกรม --- }
procedure TFrMain.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  fVideoImage.VideoStop;
  fVideoImage.Free; // คืนหน่วยความจำ
end;

end.
